<!DOCTYPE html>
<html lang="en" layout:decorate="~{layout}">
  <head>
  	<title>KT Home Automation App - Home</title>
	<script src="/static/js/Chart.bundle.min.js" th:src="@{/js/Chart.bundle.min.js}"></script>
	<script src="/static/js/sockjs.min.js" th:src="@{/js/sockjs.min.js}"></script>
	<script src="/static/js/stomp.min.js" th:src="@{/js/stomp.min.js}"></script>
  </head>
  <body>
    <div class="container-fluid" layout:fragment="content">
      <div class="row"><!-- space --> &nbsp;</div>
      <div class="row">
        <div class="col-lg-12">
          <h1 class="display-4">Home</h1>
          <canvas id="tempLogger" width="1200" height="700"></canvas>
        </div>
      </div>
	    <script type="text/javascript">
	    	// test data
			var data = {
			    labels: [],
			    datasets: [
			        {
			            label: "Test Sensor 1",
			            fillColor: "rgba(220,220,220,0.2)",
			            strokeColor: "rgba(220,220,220,1)",
			            pointColor: "rgba(220,220,220,1)",
			            pointStrokeColor: "#fff",
			            pointHighlightFill: "#fff",
			            pointHighlightStroke: "rgba(220,220,220,1)",
			            data: []
			        }
			    ]
			};
	    	var options = {
	    		responsive: false,
	    		scales: {
	    	    	yAxes: [{
	    	        	ticks: {
	    	            	max: 40,
	    	                min: 0,
	    	                stepSize: 1
	    	            }
	    	       }]
	    	    },
	    		scaleShowGridLines : true,
	   		    scaleGridLineColor : "rgba(0,0,0,.05)",
	   		    scaleGridLineWidth : 1,
	   		    scaleShowHorizontalLines: true,
	   		    scaleShowVerticalLines: true,
	   		    bezierCurve : true,
	   		    bezierCurveTension : 0.4,
	   		    pointDot : true,
	   		    pointDotRadius : 4,
	   		    pointDotStrokeWidth : 1,
	   		    pointHitDetectionRadius : 20,
	   		    datasetStroke : true,
	   		    datasetStrokeWidth : 1,
	   		    datasetFill : true,
	   		    legendTemplate : "<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<datasets.length; i++){%><li><span style=\"background-color:<%=datasets[i].strokeColor%>\"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>"
	    	};
	    	
    	 	// Get context with jQuery.
    	    var ctx = $("#tempLogger");
    	    // This will get the first returned node in the jQuery collection.
    	    var tempLogger = new Chart(ctx, {
    	    	type: 'line',
    	    	options: options,
    	    	data: data
    	    });
	    	
	    	function dataReceived (data) {
            	console.log('Received: ' + data);
            	var sensorValue = JSON.parse(data.body);
            	dataCaptureDate = new Date(sensorValue.timestamp);
            	// tempLogger.addData([sensorValue.value], dataCaptureDate.getHours() + ":" + dataCaptureDate.getMinutes() + ":" + dataCaptureDate.getSeconds());
            	tempLogger.data.datasets[0].data.push(sensorValue.value);
            	tempLogger.data.labels.push(dataCaptureDate.getHours() + ":" + dataCaptureDate.getMinutes() + ":" + dataCaptureDate.getSeconds());
            	tempLogger.update();
	    	}
	    		    	
	    	$(document).ready(function(){
	    	    // sensor to subscribe to
	    	    var sensor = "testSensor01";
	    	    // open websocket and subscribe
	            var socket = new SockJS('/temperatures');
	            stompClient = Stomp.over(socket);
	            stompClient.connect({}, (frame) => {
	                console.log('Connected: ' + frame);
	                stompClient.subscribe('/ktha/temperatures/' + sensor, dataReceived);
	            });
	    	});
	    </script>
    </div>
  </body>
</html>
